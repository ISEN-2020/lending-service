apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: lending-service-ingress
  namespace: library-system
  labels:
    app: lending-service
    component: ingress
  annotations:
    # Redirection HTTP vers HTTPS
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Configuration SSL/TLS
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-RSA-AES256-GCM-SHA384,ECDHE-RSA-AES128-GCM-SHA256"
    
    # Headers de sécurité
    nginx.ingress.kubernetes.io/server-snippet: |
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header X-XSS-Protection "1; mode=block";
      add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # Configuration du proxy
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
    
    # Rate limiting (optionnel)
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    
spec:
  ingressClassName: nginx
  
  # Configuration TLS
  tls:
  - hosts:
    - lending-service.local
    - api.lending-service.local
    secretName: lending-service-tls-secret
  
  # Routes
  rules:
  - host: lending-service.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: lending-service
            port:
              number: 443
  
  - host: api.lending-service.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: lending-service
            port:
              number: 443

---
# Service LoadBalancer pour exposition externe (optionnel)
apiVersion: v1
kind: Service
metadata:
  name: lending-service-external
  namespace: library-system
  labels:
    app: lending-service
    component: external-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:region:account:certificate/cert-id"  # Pour AWS avec ACM
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "https"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "https"
spec:
  selector:
    app: lending-service
  ports:
  - name: https
    port: 443
    targetPort: 443
    protocol: TCP
  type: LoadBalancer  # Expose le service à l'extérieur du cluster